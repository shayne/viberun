#!/usr/bin/env python3
import json
import os
import sys

CONFIG_PATH = os.environ.get("VIBERUN_CONTAINER_CONFIG", "/opt/viberun/containerconfig.json")


def load_config(path):
    try:
        with open(path, "r", encoding="utf-8") as handle:
            return json.load(handle)
    except FileNotFoundError:
        return {}
    except Exception:
        return {}


def set_env(key, value):
    if not key or value in (None, ""):
        return
    if key in os.environ:
        return
    os.environ[key] = str(value)


def apply_config(cfg):
    app_cfg = cfg.get("app") or {}
    set_env("VIBERUN_APP", app_cfg.get("name"))
    set_env("VIBERUN_CONTAINER", app_cfg.get("container"))

    ports = cfg.get("ports") or {}
    app_port = ports.get("app")
    host_port = ports.get("host")
    web_port = ports.get("web")
    if app_port is not None:
        set_env("VIBERUN_APP_PORT", app_port)
    if host_port is not None:
        set_env("VIBERUN_HOST_PORT", host_port)
        set_env("VIBERUN_PORT", host_port)
    if web_port is not None:
        set_env("VIBERUN_WEB_PORT", web_port)

    hostrpc = cfg.get("hostrpc") or {}
    set_env("VIBERUN_HOST_RPC_SOCKET", hostrpc.get("socket"))
    set_env("VIBERUN_HOST_RPC_TOKEN_FILE", hostrpc.get("token_file"))

    proxy = cfg.get("proxy") or {}
    public_url = proxy.get("public_url")
    public_domain = proxy.get("public_domain")
    url_env = proxy.get("public_url_env") or "VIBERUN_PUBLIC_URL"
    domain_env = proxy.get("public_domain_env") or "VIBERUN_PUBLIC_DOMAIN"
    if public_url:
        set_env(url_env, public_url)
    if public_domain:
        set_env(domain_env, public_domain)


if __name__ == "__main__":
    config = load_config(CONFIG_PATH)
    if isinstance(config, dict):
        apply_config(config)

    args = sys.argv[1:]
    if args and args[0] == '--':
        args = args[1:]
    if not args:
        sys.exit(0)

    os.execvp(args[0], args)
