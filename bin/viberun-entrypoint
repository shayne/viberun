#!/bin/sh
set -e

VIBERUN_HOME="${VIBERUN_HOME:-/home/viberun}"
VIBERUN_SKILLS_HOME="${VIBERUN_SKILLS_HOME:-/opt/viberun/skills}"
TEMPLATE_DIR="/opt/viberun/templates"
BOOTSTRAP_DIR="/opt/viberun/bootstrap"

ensure_dir() {
  mkdir -p "$1"
}

seed_file() {
  src="$1"
  dest="$2"
  if [ -f "$src" ] && [ ! -f "$dest" ]; then
    cp "$src" "$dest"
  fi
}

seed_tooling() {
  if [ -x "${BOOTSTRAP_DIR}/mise/mise" ] && [ ! -x "${VIBERUN_HOME}/.local/bin/mise" ]; then
    ensure_dir "${VIBERUN_HOME}/.local/bin"
    cp -P "${BOOTSTRAP_DIR}/mise/mise" "${VIBERUN_HOME}/.local/bin/mise"
    chmod +x "${VIBERUN_HOME}/.local/bin/mise"
  fi
  if [ -d "${BOOTSTRAP_DIR}/linuxbrew" ] && [ ! -x "${VIBERUN_HOME}/.linuxbrew/bin/brew" ]; then
    ensure_dir "${VIBERUN_HOME}/.linuxbrew"
    cp -R -P "${BOOTSTRAP_DIR}/linuxbrew/." "${VIBERUN_HOME}/.linuxbrew/"
  fi
}

apply_user_config() {
  config_path="/opt/viberun/userconfig.json"
  if [ ! -f "$config_path" ]; then
    return 0
  fi
  python3 - "$config_path" <<'PY'
import json
import subprocess
import sys

path = sys.argv[1]
try:
    with open(path, "r", encoding="utf-8") as fh:
        data = json.load(fh)
except Exception:
    sys.exit(0)

git_cfg = data.get("git") or {}
name = git_cfg.get("name") or ""
email = git_cfg.get("email") or ""

def set_git(key, value):
    if not value:
        return
    try:
        subprocess.run(["git", "config", "--global", key, value], check=False)
    except FileNotFoundError:
        pass

set_git("user.name", name)
set_git("user.email", email)
PY
}

ensure_dir "${VIBERUN_HOME}/app"
ensure_dir "${VIBERUN_HOME}/.local/services"
ensure_dir "${VIBERUN_HOME}/.local/logs"
ensure_dir "${VIBERUN_HOME}/.local/bin"
ensure_dir "${VIBERUN_HOME}/.config"
ensure_dir "${VIBERUN_HOME}/.codex"
ensure_dir "${VIBERUN_HOME}/.claude"
ensure_dir "${VIBERUN_HOME}/.gemini"
ensure_dir "${VIBERUN_HOME}/.config/agents"
ensure_dir "${VIBERUN_HOME}/.config/opencode"
ensure_dir "${VIBERUN_HOME}/.opencode"

seed_tooling

seed_file "${TEMPLATE_DIR}/AGENTS.app.md" "${VIBERUN_HOME}/app/AGENTS.md"
seed_file "${TEMPLATE_DIR}/mise.app.toml" "${VIBERUN_HOME}/app/.mise.toml"
seed_file "${TEMPLATE_DIR}/starship.toml" "${VIBERUN_HOME}/.config/starship.toml"
seed_file "${TEMPLATE_DIR}/codex-config.toml" "${VIBERUN_HOME}/.codex/config.toml"

trust_mise_config() {
  config_path="${VIBERUN_HOME}/app/.mise.toml"
  if [ ! -f "$config_path" ]; then
    return 0
  fi
  if [ -x "${VIBERUN_HOME}/.local/bin/mise" ]; then
    "${VIBERUN_HOME}/.local/bin/mise" trust "$config_path" >/dev/null 2>&1 || true
  elif command -v mise >/dev/null 2>&1; then
    mise trust "$config_path" >/dev/null 2>&1 || true
  fi
}

trust_mise_config

apply_user_config

sync_skills() {
  dir="$1"
  ensure_dir "$dir"
  for entry in "$dir"/*; do
    [ -e "$entry" ] || continue
    if [ -L "$entry" ]; then
      target="$(readlink "$entry" || true)"
      case "$target" in
        "${VIBERUN_SKILLS_HOME}"/*)
          if [ ! -e "$target" ]; then
            rm -f "$entry"
          fi
          ;;
      esac
    fi
  done
  if [ -d "${VIBERUN_SKILLS_HOME}" ]; then
    for skill in "${VIBERUN_SKILLS_HOME}"/*; do
      [ -d "$skill" ] || continue
      name="$(basename "$skill")"
      dest="${dir}/${name}"
      if [ -e "$dest" ] && [ ! -L "$dest" ]; then
        continue
      fi
      if [ -L "$dest" ]; then
        target="$(readlink "$dest" || true)"
        if [ "$target" != "$skill" ]; then
          rm -f "$dest"
        fi
      fi
      if [ ! -e "$dest" ]; then
        ln -s "$skill" "$dest"
      fi
    done
  fi
}

sync_skills "${VIBERUN_HOME}/.codex/skills"
sync_skills "${VIBERUN_HOME}/.claude/skills"
sync_skills "${VIBERUN_HOME}/.gemini/skills"
sync_skills "${VIBERUN_HOME}/.config/agents/skills"
sync_skills "${VIBERUN_HOME}/.config/opencode/skill"
sync_skills "${VIBERUN_HOME}/.opencode/skill"

exec "$@"
