#!/bin/sh
set -eu

mode="${1:-}"
app="${VIBERUN_APP:-}"
port="${VIBERUN_HOST_PORT:-}"
listen_port="${VIBERUN_WEB_PORT:-8080}"
public_url="${VIBERUN_PUBLIC_URL:-}"

dot_on="●"
dot_off="○"
if [ "${VIBERUN_TMUX_ASCII:-}" = "1" ]; then
  dot_on="O"
  dot_off="o"
fi

color_reset="#[default]"
color_dim="#[fg=colour245]"
color_muted="#[fg=colour240]"
color_green="#[fg=colour35]"
color_sep="#[fg=colour238]"
update_file="/var/run/viberun-hostrpc/update.json"

shell_window_exists() {
  windows="$(tmux list-windows -F '#{window_name}' 2>/dev/null || true)"
  printf "%s\n" "$windows" | grep -qx "shell"
}

set_status_url() {
  value="$1"
  if [ -n "$value" ]; then
    tmux set-environment -g VIBERUN_STATUS_URL "$value" >/dev/null 2>&1 || true
    return
  fi
  tmux set-environment -g -u VIBERUN_STATUS_URL >/dev/null 2>&1 || true
}

url_wrap() {
  text="$1"
  printf "#[range=user|url]%s#[range=default]" "$text"
}

detach_button() {
  printf "%s|%s %s#[bold]#[range=user|detach]detach#[range=default]%s " \
    "$color_sep" "$color_reset" "$color_dim" "$color_reset"
}

shell_button() {
  if shell_window_exists; then
    return
  fi
  printf "%s#[range=user|shell]shell#[range=default]%s" "$color_dim" "$color_reset"
}

is_listening() {
  ss_out="$(ss -ltn 2>/dev/null)" || return 2
  printf "%s\n" "$ss_out" | grep -q ":${listen_port} "
}

update_available() {
  if [ -z "$app" ]; then
    return 1
  fi
  if [ ! -f "$update_file" ]; then
    return 1
  fi
  grep -q '"available"[[:space:]]*:[[:space:]]*true' "$update_file"
}

status_tail() {
  if update_available; then
    printf "%s|%s %supdate available%s %s|%s %sviberun %s update%s%s" \
      "$color_sep" "$color_reset" "$color_dim" "$color_reset" \
      "$color_sep" "$color_reset" "$color_dim" "$app" "$color_reset" \
      "$(detach_button)"
    return
  fi
  printf "%s" "$(detach_button)"
}

print_status() {
  icon_color="$1"
  icon="$2"
  label_color="$3"
  label="$4"
  tail="$(status_tail)"
  printf "%s%s%s %s%s%s %s" \
    "$icon_color" "$icon" "$color_reset" \
    "$label_color" "$label" "$color_reset" \
    "$tail"
}

case "$mode" in
  left)
    label="viberun"
    if [ -n "$app" ]; then
      label="$label $app"
    fi
    printf "%s %s|%s" "$label" "$color_sep" "$color_reset"
    ;;
  right)
    shell="$(shell_button)"
    if [ -n "$shell" ]; then
      shell=" $shell"
    fi
    if [ -z "$port" ]; then
      set_status_url ""
      printf "%s%s%s%s" "#[align=left]" "$shell" "#[align=right]" "$(detach_button)"
      exit 0
    fi
    if is_listening; then
      label="http://localhost:${port}"
      if [ -n "$public_url" ]; then
        label="$public_url"
      fi
      set_status_url "$label"
      label="$(url_wrap "$label")"
      printf "%s%s%s%s" "#[align=left]" "$shell" "#[align=right]" "$(print_status "$color_green" "$dot_on" "$color_green" "$label")"
    else
      set_status_url ""
      case $? in
        2)
          printf "%s%s%s%s" "#[align=left]" "$shell" "#[align=right]" "$(print_status "$color_muted" "!" "$color_muted" "svc check err")"
          ;;
        *)
          printf "%s%s%s%s" "#[align=left]" "$shell" "#[align=right]" "$(print_status "$color_muted" "$dot_off" "$color_muted" "no web svc")"
          ;;
      esac
    fi
    ;;
esac
