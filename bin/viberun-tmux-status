#!/bin/sh
set -eu

mode="${1:-}"
app="${VIBERUN_APP:-}"
agent="${VIBERUN_AGENT:-}"
port="${VIBERUN_HOST_PORT:-}"
listen_port="${VIBERUN_WEB_PORT:-8080}"
public_url="${VIBERUN_PUBLIC_URL:-}"

dot_on="●"
dot_off="○"
if [ "${VIBERUN_TMUX_ASCII:-}" = "1" ]; then
  dot_on="O"
  dot_off="o"
fi

color_reset="#[default]"
color_dim="#[fg=colour245]"
color_muted="#[fg=colour240]"
color_green="#[fg=colour35]"
color_sep="#[fg=colour238]"
update_file="/var/run/viberun-hostrpc/update.json"
tail_default="${color_sep}|${color_reset} ${color_dim}ctrl-\\ to close${color_reset}"

is_listening() {
  ss_out="$(ss -ltn 2>/dev/null)" || return 2
  printf "%s\n" "$ss_out" | grep -q ":${listen_port} "
}

update_available() {
  if [ -z "$app" ]; then
    return 1
  fi
  if [ ! -f "$update_file" ]; then
    return 1
  fi
  grep -q '"available"[[:space:]]*:[[:space:]]*true' "$update_file"
}

status_tail() {
  if update_available; then
    printf "%s|%s %supdate available%s %s|%s %sctrl-\\\\ to close%s %s|%s %sviberun %s update%s" \
      "$color_sep" "$color_reset" "$color_dim" "$color_reset" \
      "$color_sep" "$color_reset" "$color_dim" "$color_reset" \
      "$color_sep" "$color_reset" "$color_dim" "$app" "$color_reset"
    return
  fi
  printf "%s" "$tail_default"
}

print_close_hint() {
  printf "%sctrl-\\ to close%s" "$color_dim" "$color_reset"
}

print_status() {
  icon_color="$1"
  icon="$2"
  label_color="$3"
  label="$4"
  tail="$(status_tail)"
  printf "%s%s%s %s%s%s %s" \
    "$icon_color" "$icon" "$color_reset" \
    "$label_color" "$label" "$color_reset" \
    "$tail"
}

case "$mode" in
  left)
    label="viberun"
    if [ -n "$app" ]; then
      label="$label $app"
    fi
    printf "%s" "$label"
    ;;
  right)
    if [ -z "$port" ]; then
      print_close_hint
      exit 0
    fi
    if is_listening; then
      label="http://localhost:${port}"
      if [ -n "$public_url" ]; then
        label="$public_url"
      fi
      print_status "$color_green" "$dot_on" "$color_green" "$label"
    else
      case $? in
        2)
          print_status "$color_muted" "!" "$color_muted" "svc check err"
          ;;
        *)
          print_status "$color_muted" "$dot_off" "$color_muted" "no web svc"
          ;;
      esac
    fi
    ;;
esac
